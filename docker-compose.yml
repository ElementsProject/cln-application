version: "3.8"

services:
  bitcoind:
    image: lncm/bitcoind:v24.0@sha256:db19fe46f30acd3854f4f0d239278137d828ce3728f925c8d92faaab1ba8556a
    command:
      - -${BITCOIN_NETWORK}
      - -fallbackfee=0.0002
      - -rpcbind=0.0.0.0
      - -rpcallowip=0.0.0.0/0
      - -rpcauth=user:d58ddb294b3a3812ff5fee50d6f24b29$19212992730deeaf6e596d471260a966b011a00446d45b193c94e79c4f4a1266
    restart: on-failure
    volumes:
      - ${PWD}/data/bitcoin:/root/.bitcoin
    networks:
      networkcln:
        ipv4_address: ${BITCOIN_HOST}

  lightningd:
    image: lncm/clightning:v22.11.1@sha256:e9939341ca6736566e0499db5a339b25140d6e77fb16ab202c217112f0df9b77
    command:
      - --bitcoin-rpcconnect=${BITCOIN_HOST}
      - --bitcoin-rpcuser=${APP_BITCOIN_RPC_USER}
      - --bitcoin-rpcpassword=${APP_BITCOIN_RPC_PASS}
      - --bind-addr=${LIGHTNING_IP}:9735
      - --network=${BITCOIN_NETWORK}
      - --database-upgrade=true
      - --grpc-port=${LIGHTNING_GRPC_PORT}
      - --experimental-websocket-port=${LIGHTNING_WS_PORT}
      - --experimental-offers
    restart: on-failure
    volumes:
      - ${PWD}/data/lightningd:${LIGHTNING_DATA_DIR}
    ports:
      - ${LIGHTNING_WS_PORT}:${LIGHTNING_WS_PORT}
    networks:
      networkcln:
        ipv4_address: ${LIGHTNING_IP}

  lightningd-2:
    image: lncm/clightning:v22.11.1@sha256:e9939341ca6736566e0499db5a339b25140d6e77fb16ab202c217112f0df9b77
    command:
      - --bitcoin-rpcconnect=${BITCOIN_HOST}
      - --bitcoin-rpcuser=${APP_BITCOIN_RPC_USER}
      - --bitcoin-rpcpassword=${APP_BITCOIN_RPC_PASS}
      - --bind-addr=170.21.22.13:9736
      - --network=${BITCOIN_NETWORK}
      - --database-upgrade=true
      # - --grpc-port=${LIGHTNING_GRPC_PORT}
      - --experimental-websocket-port=2116
      - --experimental-offers
    restart: on-failure
    volumes:
      - ${PWD}/data/lightningd-2:${LIGHTNING_DATA_DIR}
    ports:
      - 2116:2116
    networks:
      networkcln:
        ipv4_address: 170.21.22.13

  application:
    build:
      dockerfile: ./Dockerfile
      context: ./
    # image: ghcr.io/elementsproject/cln-application:0.0.2@sha256:6188255f56a679b9e5785036ab50ad1d2c869568c2f29d07f0c482917c7442e9
    depends_on:
      - bitcoind
      - lightningd
    environment:
      APP_SINGLE_SIGN_ON: ${APP_SINGLE_SIGN_ON}
      BITCOIN_HOST: ${BITCOIN_HOST}
      BITCOIN_NETWORK: ${BITCOIN_NETWORK}
      APP_CONFIG_FILE: ${APP_CONFIG_FILE}
      APP_LOG_FILE: ${APP_LOG_FILE}
      APP_MODE: ${APP_MODE}
      APP_CONNECT: ${APP_CONNECT}
      APP_PROTOCOL: ${APP_PROTOCOL}
      APP_HOST: ${APP_HOST}
      APP_PORT: ${APP_PORT}
      LIGHTNING_DATA_DIR: ${LIGHTNING_DATA_DIR}
      LIGHTNING_HOST: ${LIGHTNING_HOST}
      LIGHTNING_TOR_HOST: ${LIGHTNING_TOR_HOST}
      LIGHTNING_VARS_FILE: ${LIGHTNING_VARS_FILE}
      LIGHTNING_WS_PROTOCOL: ${LIGHTNING_WS_PROTOCOL}
      LIGHTNING_WS_PORT: ${LIGHTNING_WS_PORT},
      LIGHTNING_WS_CLIENT_KEY_FILE: ${LIGHTNING_WS_CLIENT_KEY_FILE}
      LIGHTNING_WS_CLIENT_CERT_FILE: ${LIGHTNING_WS_CLIENT_CERT_FILE}
      LIGHTNING_WS_CA_CERT_FILE: ${LIGHTNING_WS_CA_CERT_FILE}
      LIGHTNING_REST_PROTOCOL: ${LIGHTNING_REST_PROTOCOL}
      LIGHTNING_REST_HOST: ${LIGHTNING_REST_HOST}
      LIGHTNING_REST_TOR_HOST: ${LIGHTNING_REST_TOR_HOST}
      LIGHTNING_REST_PORT: ${LIGHTNING_REST_PORT},
      LIGHTNING_REST_CLIENT_KEY_FILE: ${LIGHTNING_REST_CLIENT_KEY_FILE}
      LIGHTNING_REST_CLIENT_CERT_FILE: ${LIGHTNING_REST_CLIENT_CERT_FILE}
      LIGHTNING_REST_CA_CERT_FILE: ${LIGHTNING_REST_CA_CERT_FILE}
      LIGHTNING_GRPC_HOST: ${LIGHTNING_GRPC_HOST}
      LIGHTNING_GRPC_TOR_HOST: ${LIGHTNING_GRPC_TOR_HOST}
      LIGHTNING_GRPC_PORT: ${LIGHTNING_GRPC_PORT}
      LIGHTNING_GRPC_PROTO_PATH: ${LIGHTNING_GRPC_PROTO_PATH}
      LIGHTNING_GRPC_CLIENT_KEY_FILE: ${LIGHTNING_GRPC_CLIENT_KEY_FILE}
      LIGHTNING_GRPC_CLIENT_CERT_FILE: ${LIGHTNING_GRPC_CLIENT_CERT_FILE}
      LIGHTNING_GRPC_CA_CERT_FILE: ${LIGHTNING_GRPC_CA_CERT_FILE}
    command: npm run start
    restart: on-failure
    volumes:
      - ${PWD}/data/lightningd:${LIGHTNING_DATA_DIR}
      - ${PWD}/data/c-lightning-rest/certs:/c-lightning-rest/certs
      - ${PWD}/data/app:/data/app
    ports:
      - "${APP_PORT}:${APP_PORT}"
    networks:
      networkcln:
        ipv4_address: ${APP_HOST}

  application-2:
    build:
      dockerfile: ./Dockerfile
      context: ./
    # image: ghcr.io/elementsproject/cln-application:0.0.2@sha256:6188255f56a679b9e5785036ab50ad1d2c869568c2f29d07f0c482917c7442e9
    depends_on:
      - bitcoind
      - lightningd
    environment:
      BITCOIN_NETWORK: ${BITCOIN_NETWORK}
      LIGHTNING_HOST: 170.21.22.13
      APP_MODE: "production"
      APP_HOST: 170.21.22.15
      APP_PORT: 2113
      LIGHTNING_TOR_HOST: ${LIGHTNING_TOR_HOST}
      LIGHTNING_VARS_FILE: ${LIGHTNING_VARS_FILE}
      LIGHTNING_WS_PORT: 2116
      LIGHTNING_REST_PORT: ${LIGHTNING_REST_PORT}
      LIGHTNING_GRPC_PORT: ${LIGHTNING_GRPC_PORT}
      LIGHTNING_GRPC_PROTO_PATH: ${LIGHTNING_GRPC_PROTO_PATH}
      LIGHTNING_DATA_DIR: ${LIGHTNING_DATA_DIR}
      LIGHTNING_REST_CLIENT_KEY_FILE: ${LIGHTNING_DATA_DIR}/bitcoin/client-key.pem
      LIGHTNING_REST_CLIENT_CERT_FILE: ${LIGHTNING_DATA_DIR}/bitcoin/client.pem
      LIGHTNING_REST_CA_CERT_FILE: ${LIGHTNING_DATA_DIR}/bitcoin/ca.pem
    command: npm run start
    restart: on-failure
    volumes:
      - ${PWD}/data/lightningd-2:${LIGHTNING_DATA_DIR}
      - ${PWD}/data/c-lightning-rest/certs:/c-lightning-rest/certs
      - ${PWD}/data/app-2:/data/app
    ports:
      - 2113:2113
    networks:
      networkcln:
        ipv4_address: 170.21.22.15

networks:
  networkcln:
    driver: bridge
    ipam:
      config:
        - subnet: 170.21.22.0/16
          gateway: 170.21.22.0
